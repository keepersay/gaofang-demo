# 逻辑集群组类型设计方案

## 1. 需求概述

逻辑集群组类型需要从原有的"分布式/非分布式"二元选择扩展为三种类型的互斥选择：主备、分布式和Anycast。不同类型下的集群选择规则和交互方式也有所不同。

## 2. 设计目标

- 扩展集群组类型，支持主备、分布式和Anycast三种类型
- 实现不同类型下的集群选择规则和校验逻辑
- 提供清晰的用户界面和交互体验
- 确保与现有系统的兼容性

## 3. 类型定义与规则

### 3.1 主备类型
- **定义**：单一主集群和可选的备集群组合，限定在特定机房内
- **规则**：
  - 只能选择一个主集群（必选）
  - 最多可选择一个备集群（可选）
  - 必须选择特定机房，集群选择受机房限制
  - 适用于需要明确主备关系且位于同一机房的场景

### 3.2 分布式类型
- **定义**：多主集群和可选的备集群组合，不限制机房
- **规则**：
  - 可选择多个主集群（至少1个）
  - 必须指定一个默认集群（从主集群中选择）
  - 最多可选择一个备集群（可选）
  - 不限制机房，可选择任意活跃集群
  - 适用于跨机房部署的分布式场景

### 3.3 Anycast类型
- **定义**：多主集群组合，不支持备集群，不限制机房
- **规则**：
  - 可选择多个主集群（至少1个）
  - 不需要默认集群
  - 不支持备集群（不能选择备集群）
  - 不限制机房，可选择任意活跃集群
  - 适用于Anycast网络部署场景

## 4. 界面设计

### 4.1 类型选择
- 采用单选按钮组（el-radio-group）实现三种类型的互斥选择
- 每种类型提供简洁明了的描述文本，帮助用户理解
- 类型选择位于表单顶部，作为核心配置项

### 4.2 机房选择
- 主备类型：显示机房选择下拉框，必选
- 分布式和Anycast类型：不显示机房选择，不限制机房

### 4.3 集群选择
- **主集群选择**：
  - 主备类型：单选主集群，受机房限制
  - 分布式类型：多选主集群，不限机房
  - Anycast类型：多选主集群，不限机房
- **默认集群选择**：
  - 仅分布式类型显示，从已选主集群中选择一个作为默认
- **备集群选择**：
  - 主备和分布式类型显示，Anycast类型不显示
  - 主备类型：从同机房中选择未被选为主集群的集群
  - 分布式类型：从所有未被选为主集群的集群中选择

## 5. 数据结构

### 5.1 集群组对象结构
```javascript
{
  id: string,            // 集群组ID
  name: string,          // 集群组名称
  type: string,          // 集群组类型：'standby'/'distributed'/'anycast'
  distributed: boolean,  // 兼容旧数据：是否分布式
  dataCenterId: string,  // 机房ID（主备类型必选）
  primaryClusters: string[],  // 主集群ID数组
  standbyClusters: string[],  // 备集群ID数组
  defaultClusterId: string,   // 默认集群ID（分布式类型必选）
  addressType: string,   // 地址类型：'ipv4'/'ipv6'/'dual'
  status: string,        // 状态：'active'/'disabled'
  remark: string,        // 备注
  createTime: string,    // 创建时间
  createAccount: string, // 创建人
  updateTime: string,    // 更新时间
  updateAccount: string  // 更新人
}
```

### 5.2 兼容性处理
- 保留`distributed`字段以兼容历史数据
- 新增`type`字段，支持三种类型
- 对于历史数据，根据`distributed`字段值映射到对应的`type`：
  - distributed=true → type='distributed'
  - distributed=false → type='standby'

## 6. 交互逻辑

### 6.1 类型切换逻辑
- 切换类型时自动清空相关字段（主集群、备集群、默认集群）
- 切换到主备类型时，显示机房选择
- 切换到分布式或Anycast类型时，隐藏机房选择并清空机房值

### 6.2 表单校验规则
- **主备类型**：
  - 机房必选
  - 主集群必选且只能选1个
  - 备集群最多1个
- **分布式类型**：
  - 主集群至少1个
  - 默认集群必选（从主集群中选择）
  - 备集群最多1个
- **Anycast类型**：
  - 主集群至少1个
  - 不能选择备集群

### 6.3 智能交互
- 主集群选择后自动更新默认集群选项（分布式类型）
- 实时校验主备集群数量，防止超出限制
- 类型切换时提供清晰的提示文本
- 备集群选择时自动过滤掉已选为主集群的选项

## 7. 表格展示

### 7.1 表格列定义
- **ID**：集群组唯一标识
- **名称**：集群组名称
- **类型**：显示"主备"/"分布式"/"Anycast"，不同类型使用不同颜色标签
- **机房**：
  - 主备类型：显示所选机房名称
  - 分布式和Anycast类型：显示"不限制"
- **主集群**：显示所有主集群名称，默认集群有特殊标识
- **备集群**：
  - 有备集群时显示备集群名称
  - Anycast类型显示"不支持"
  - 无备集群时显示"无"
- **状态**：显示"启用"/"禁用"
- **操作**：提供编辑、状态切换、删除等操作

### 7.2 默认集群标识
- 在表格的主集群列中，为默认集群添加特殊样式或标识
- 仅分布式类型的集群组显示默认集群标识

## 8. 实现注意事项

### 8.1 前端实现
- 使用Vue 3的响应式API实现类型切换和表单联动
- 采用计算属性处理不同类型下的可选集群列表
- 添加监听器处理类型变化和主集群变化

### 8.2 后端兼容
- 向后端传递type字段和distributed字段，确保兼容性
- 对接收的数据进行兼容性处理，支持新旧两种数据结构

### 8.3 性能优化
- 避免不必要的集群数据重复加载
- 利用计算属性缓存过滤后的集群列表

## 9. 未来拓展

### 9.1 可能的功能扩展
- 支持更多集群组类型
- 增强默认集群的功能和策略
- 添加集群组间的关联关系

### 9.2 接口优化
- 完全移除distributed字段，统一使用type字段
- 增加集群组类型相关的统计和分析功能 