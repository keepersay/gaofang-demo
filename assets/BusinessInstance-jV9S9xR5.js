import{_ as we,a as b,r as _e,c as Ie,n as ee,e as g,l as w,g as y,w as a,d as t,h as f,i as te,b as B,F as ge,p as ye,t as V,z as ve,v as S,k as i,B as O,E as v,A as ke,C as Pe,f as Te,o as xe,j as Ne,u as Ae,G as Ge,q as Se}from"./index-Ye2ufiks.js";const Ue={style:{color:"#999"}},$e={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Be={key:0,class:"form-tip"},ze={style:{"margin-top":"20px",display:"flex","justify-content":"space-between"}},Re={__name:"BusinessInstanceModal",props:{modelValue:{type:Boolean,default:!1},instanceData:{type:Object,default:null},isEdit:{type:Boolean,default:!1}},emits:["update:modelValue","success"],setup(M,{emit:Y}){const I=M,q=Y,z=b(!1),x=_e({customers:!1,orders:!1,regions:!1,clusterGroups:!1,resourceCheck:!1}),T=b({}),k=Ie({get:()=>I.modelValue,set:o=>q("update:modelValue",o)}),P=Ie(()=>I.isEdit),R=b(),d=b(0),e=_e({instanceName:"",customerId:"",customerName:"",orderId:"",packageId:"",packageName:"",packageType:1,clusterType:"standby",addressType:"IPv4",regionId:"",adsProtection:!0,ccProtection:!1,wafProtection:!1,bandwidth:100,businessBandwidth:50,qps:1e3,protectionIpCount:1,domainCount:10,portCount:10,status:"active",remark:"",clusterGroupId:"",previousClusterGroupId:""}),C={instanceName:[{required:!0,message:"请输入业务实例名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],customerId:[{required:!0,message:"请选择客户",trigger:"change"}],orderId:[{required:!0,message:"请选择关联订单",trigger:"change"}],clusterType:[{required:!0,message:"请选择集群类型",trigger:"change"}],addressType:[{required:!0,message:"请选择地址类型",trigger:"change"}],regionId:[{required:()=>e.clusterType==="standby",message:"请选择地域",trigger:"change"}],clusterGroupId:[{required:!0,message:"请选择逻辑集群组",trigger:"change"}],status:[{required:!0,message:"请选择实例状态",trigger:"change"}]},U=b([]),N=b([]),Q=b([]),K=b([]),H=()=>{e.instanceName="",e.customerId="",e.customerName="",e.orderId="",e.packageId="",e.packageName="",e.packageType=1,e.clusterType="standby",e.addressType="IPv4",e.regionId="",e.adsProtection=!0,e.ccProtection=!1,e.wafProtection=!1,e.bandwidth=100,e.businessBandwidth=50,e.qps=1e3,e.protectionIpCount=1,e.domainCount=10,e.portCount=10,e.status="active",e.remark="",e.clusterGroupId="",e.previousClusterGroupId=""};ee(()=>I.instanceData,o=>{o?(Object.keys(e).forEach(l=>{o[l]!==void 0&&(e[l]=o[l])}),o.packageName&&(o.packageName==="DDOS防护"?(e.adsProtection=!0,e.ccProtection=!1,e.wafProtection=!1,e.packageType=1,o.clusterType||(e.clusterType="standby")):o.packageName==="WAF标准防护"?(e.adsProtection=!0,e.ccProtection=!0,e.wafProtection=!1,e.packageType=2,o.clusterType||(e.clusterType="distributed")):o.packageName==="WAF增强防护"&&(e.adsProtection=!0,e.ccProtection=!0,e.wafProtection=!0,e.packageType=3,o.clusterType||(e.clusterType="anycast"))),!o.clusterType&&o.isAnycast!==void 0&&(e.clusterType=o.isAnycast?"anycast":"standby"),o.clusterGroupId&&F(o.clusterGroupId),ae()):H()},{immediate:!0,deep:!0}),ee(()=>k.value,o=>{o&&(d.value=0,ke(()=>{se(),re(),h()}))});const se=async()=>{try{U.value=[{customerId:"CUST1001",customerName:"北京科技有限公司"},{customerId:"CUST1002",customerName:"上海网络科技有限公司"},{customerId:"CUST1003",customerName:"广州信息技术有限公司"},{customerId:"CUST1004",customerName:"深圳互联网有限公司"},{customerId:"CUST1005",customerName:"杭州数字科技有限公司"}]}catch(o){console.error("获取客户列表失败:",o)}},ae=async()=>{try{const o=new URLSearchParams;e.customerId&&o.append("customerId",e.customerId);const l=await O.getAvailableOrders({customerId:e.customerId});l.code===200&&(N.value=l.data)}catch(o){console.error("获取订单列表失败:",o)}},re=async()=>{try{Q.value=[{regionId:"cn-beijing",regionName:"华北-北京"},{regionId:"cn-shanghai",regionName:"华东-上海"},{regionId:"cn-guangzhou",regionName:"华南-广州"},{regionId:"cn-hangzhou",regionName:"华东-杭州"},{regionId:"cn-shenzhen",regionName:"华南-深圳"}]}catch(o){console.error("获取地域列表失败:",o)}},ue=o=>{e.orderId="";const l=U.value.find(A=>A.customerId===o);l&&(e.customerName=l.customerName),ae()},ie=o=>{const l=N.value.find(A=>A.orderId===o);l&&(e.packageName=l.packageName,l.packageName==="DDOS防护"?(e.packageType=1,e.adsProtection=!0,e.ccProtection=!1,e.wafProtection=!1):l.packageName==="WAF标准防护"?(e.packageType=2,e.adsProtection=!0,e.ccProtection=!0,e.wafProtection=!1):l.packageName==="WAF增强防护"&&(e.packageType=3,e.adsProtection=!0,e.ccProtection=!0,e.wafProtection=!0),l.clusterType&&(e.clusterType=l.clusterType),e.clusterType==="anycast"&&(e.regionId=""),e.clusterGroupId="",e.previousClusterGroupId="")},de=()=>{d.value>0&&d.value--},pe=async()=>{if(d.value===0)try{await R.value.validateField(["instanceName","customerId","orderId"]),d.value++}catch(o){console.error(o)}else if(d.value===1)try{await R.value.validateField(["addressType"]),e.clusterType==="standby"&&await R.value.validateField(["regionId"]),await R.value.validateField(["clusterGroupId"]),d.value++}catch(o){console.error(o)}else d.value<4&&d.value++},ce=()=>{k.value=!1,H()},p=async()=>{try{await R.value.validate(),z.value=!0;let o;if(I.isEdit){const l={...e},A=l.clusterGroupId!==I.instanceData.clusterGroupId;o=await O.updateBusinessInstance(I.instanceData.instanceId,l),o.code===200?(v.success("更新成功"),A&&((await O.autoAllocateIpGroups(o.data.instanceId)).code===200?v.success("已自动重新分配防护IP组"):v.warning("自动分配防护IP组失败，可能需要手动分配")),k.value=!1,q("success")):v.error(o.message||"更新失败")}else o=await O.createBusinessInstance(e),o.code===200?(v.success("创建成功"),(await O.autoAllocateIpGroups(o.data.instanceId)).code===200?v.success("已自动分配防护IP组"):v.warning("自动分配防护IP组失败，可能需要手动分配"),k.value=!1,q("success")):v.error(o.message||"创建失败")}catch(o){console.error("表单提交失败:",o)}finally{z.value=!1}},r=o=>{o===1?(e.adsProtection=!0,e.ccProtection=!1,e.wafProtection=!1):o===2?(e.adsProtection=!0,e.ccProtection=!0,e.wafProtection=!1):o===3&&(e.adsProtection=!0,e.ccProtection=!0,e.wafProtection=!0)},$=()=>{e.clusterType!=="anycast"&&e.regionId};ee(()=>e.clusterType,o=>{(o==="anycast"||o==="distributed")&&(e.regionId="")}),ee([()=>e.clusterType,()=>e.addressType],([o])=>{(o==="anycast"||o==="distributed")&&(e.regionId=""),e.clusterGroupId&&X(e.clusterGroupId)}),ee(()=>e.protectionIpCount,(o,l)=>{o!==l&&e.clusterGroupId&&X(e.clusterGroupId)});const h=async()=>{try{x.clusterGroups=!0;const o=await Pe.getClusterGroups();K.value=o}catch(o){console.error("获取逻辑集群组列表失败:",o),v.error("获取逻辑集群组列表失败")}finally{x.clusterGroups=!1}},F=async o=>{try{const l=await Pe.getClusterGroupById(o);l&&(e.clusterGroupId=l.id)}catch(l){console.error("获取逻辑集群组详情失败:",l)}},le=Ie(()=>K.value.length?K.value.filter(o=>o.status!=="active"?!1:e.clusterType==="standby"?o.type==="standby"||!o.type&&!o.distributed:e.clusterType==="distributed"?o.type==="distributed"||!o.type&&o.distributed:e.clusterType==="anycast"?o.type==="anycast":!0):[]),me=o=>o.type==="anycast"?"warning":o.type==="distributed"||o.distributed?"success":"info",J=o=>o.type==="anycast"?"Anycast":o.type==="distributed"||o.distributed?"分布式":"主备",fe=async()=>{e.clusterGroupId!==e.previousClusterGroupId&&(await X(e.clusterGroupId),e.previousClusterGroupId=e.clusterGroupId)},X=async o=>{if(o){x.resourceCheck=!0;try{const l=await O.checkClusterGroupIpResource(o,e.addressType,e.protectionIpCount);l.code===200?(T.value={...T.value,[o]:l.data.sufficient?"sufficient":"insufficient"},l.data.sufficient||v.warning(`所选逻辑集群组的IP资源不足，无法满足${e.protectionIpCount}组IP的分配需求`)):v.error(l.message||"检查资源充足性失败")}catch(l){console.error("检查资源充足性失败:",l),v.error("检查资源充足性失败")}finally{x.resourceCheck=!1}}},E=()=>{(e.clusterType==="anycast"||e.clusterType==="distributed")&&(e.regionId=""),e.clusterGroupId="",e.previousClusterGroupId=""};return(o,l)=>{const A=g("el-step"),s=g("el-steps"),n=g("el-input"),c=g("el-form-item"),W=g("el-option"),_=g("el-select"),G=g("el-radio"),ne=g("el-radio-group"),Z=g("el-tag"),D=g("el-alert"),L=g("el-input-number"),be=g("el-form"),oe=g("el-button"),Ce=g("el-dialog");return y(),w(Ce,{modelValue:k.value,"onUpdate:modelValue":l[16]||(l[16]=u=>k.value=u),title:P.value?"修改业务实例":"新增业务实例",width:"60%","destroy-on-close":""},{default:a(()=>[t(s,{active:d.value,"finish-status":"success",simple:"",style:{"margin-bottom":"20px"}},{default:a(()=>[t(A,{title:"基本信息"}),t(A,{title:"部署配置"}),t(A,{title:"防护选项"}),t(A,{title:"资源配置"}),t(A,{title:"状态与备注"})]),_:1},8,["active"]),t(be,{ref_key:"formRef",ref:R,model:e,rules:C,"label-width":"120px",style:{"max-height":"500px","overflow-y":"auto"}},{default:a(()=>[te(f("div",null,[t(c,{label:"业务实例名称",prop:"instanceName"},{default:a(()=>[t(n,{modelValue:e.instanceName,"onUpdate:modelValue":l[0]||(l[0]=u=>e.instanceName=u),placeholder:"请输入业务实例名称"},null,8,["modelValue"])]),_:1}),t(c,{label:"客户",prop:"customerId"},{default:a(()=>[t(_,{modelValue:e.customerId,"onUpdate:modelValue":l[1]||(l[1]=u=>e.customerId=u),placeholder:"请选择客户",filterable:"",style:{width:"100%"},onChange:ue},{default:a(()=>[(y(!0),B(ge,null,ye(U.value,u=>(y(),w(W,{key:u.customerId,label:u.customerName,value:u.customerId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"关联订单",prop:"orderId"},{default:a(()=>[t(_,{modelValue:e.orderId,"onUpdate:modelValue":l[2]||(l[2]=u=>e.orderId=u),placeholder:"请选择关联订单",filterable:"",style:{width:"100%"},disabled:!e.customerId,onChange:ie},{default:a(()=>[(y(!0),B(ge,null,ye(N.value,u=>(y(),w(W,{key:u.orderId,label:u.orderId,value:u.orderId},{default:a(()=>[f("div",null,[f("div",null,V(u.orderId),1),f("small",Ue,V(u.packageName),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})],512),[[ve,d.value===0]]),te(f("div",null,[t(c,{label:"集群类型",prop:"clusterType"},{default:a(()=>[t(ne,{modelValue:e.clusterType,"onUpdate:modelValue":l[3]||(l[3]=u=>e.clusterType=u),onChange:E},{default:a(()=>[t(G,{value:"standby"},{default:a(()=>l[17]||(l[17]=[i("主备")])),_:1,__:[17]}),t(G,{value:"distributed"},{default:a(()=>l[18]||(l[18]=[i("分布式")])),_:1,__:[18]}),t(G,{value:"anycast"},{default:a(()=>l[19]||(l[19]=[i("Anycast")])),_:1,__:[19]})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"地址类型",prop:"addressType"},{default:a(()=>[t(ne,{modelValue:e.addressType,"onUpdate:modelValue":l[4]||(l[4]=u=>e.addressType=u)},{default:a(()=>[t(G,{value:"IPv4"},{default:a(()=>l[20]||(l[20]=[i("IPv4")])),_:1,__:[20]}),t(G,{value:"IPv6"},{default:a(()=>l[21]||(l[21]=[i("IPv6")])),_:1,__:[21]}),t(G,{value:"dual"},{default:a(()=>l[22]||(l[22]=[i("双栈")])),_:1,__:[22]})]),_:1},8,["modelValue"])]),_:1}),e.clusterType==="standby"?(y(),w(c,{key:0,label:"地域",prop:"regionId"},{default:a(()=>[t(_,{modelValue:e.regionId,"onUpdate:modelValue":l[5]||(l[5]=u=>e.regionId=u),placeholder:"请选择地域",style:{width:"100%"},onChange:$},{default:a(()=>[(y(!0),B(ge,null,ye(Q.value,u=>(y(),w(W,{key:u.regionId,label:u.regionName,value:u.regionId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):S("",!0),t(c,{label:"逻辑集群组",prop:"clusterGroupId"},{default:a(()=>[t(_,{modelValue:e.clusterGroupId,"onUpdate:modelValue":l[6]||(l[6]=u=>e.clusterGroupId=u),placeholder:"请选择逻辑集群组",filterable:"",style:{width:"100%"},loading:x.clusterGroups,onChange:fe},{default:a(()=>[(y(!0),B(ge,null,ye(le.value,u=>(y(),w(W,{key:u.id,label:u.name,value:u.id,disabled:T.value[u.id]==="insufficient"},{default:a(()=>[f("div",$e,[f("span",null,V(u.name),1),f("div",null,[t(Z,{size:"small",type:me(u),style:{"margin-right":"5px"}},{default:a(()=>[i(V(J(u)),1)]),_:2},1032,["type"]),T.value[u.id]?(y(),w(Z,{key:0,size:"small",type:T.value[u.id]==="sufficient"?"success":"danger"},{default:a(()=>[i(V(T.value[u.id]==="sufficient"?"资源充足":"资源不足"),1)]),_:2},1032,["type"])):S("",!0)])])]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue","loading"]),l[23]||(l[23]=f("div",{class:"form-tip"},"请选择与订单集群类型相匹配的逻辑集群组",-1)),x.resourceCheck?(y(),B("div",Be,"正在检查网池资源充足性...")):S("",!0)]),_:1,__:[23]})],512),[[ve,d.value===1]]),te(f("div",null,[t(D,{title:"防护配置与套餐对应关系",type:"info",description:"ADS防护 -> DDOS防护；ADS防护+CC防护 -> WAF标准防护；ADS防护+CC防护+WAF防护 -> WAF增强防护",closable:!1,style:{"margin-bottom":"20px"}}),t(c,{label:"套餐选择",prop:"packageType"},{default:a(()=>[t(ne,{modelValue:e.packageType,"onUpdate:modelValue":l[7]||(l[7]=u=>e.packageType=u),onChange:r},{default:a(()=>[t(G,{label:1},{default:a(()=>l[24]||(l[24]=[i("DDOS防护（仅ADS防护）")])),_:1,__:[24]}),t(G,{label:2},{default:a(()=>l[25]||(l[25]=[i("WAF标准防护（ADS+CC防护）")])),_:1,__:[25]}),t(G,{label:3},{default:a(()=>l[26]||(l[26]=[i("WAF增强防护（ADS+CC+WAF防护）")])),_:1,__:[26]})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"防护内容"},{default:a(()=>[e.adsProtection?(y(),w(Z,{key:0,type:"success",style:{"margin-right":"5px"}},{default:a(()=>l[27]||(l[27]=[i("ADS防护")])),_:1,__:[27]})):S("",!0),e.ccProtection?(y(),w(Z,{key:1,type:"warning",style:{"margin-right":"5px"}},{default:a(()=>l[28]||(l[28]=[i("CC防护")])),_:1,__:[28]})):S("",!0),e.wafProtection?(y(),w(Z,{key:2,type:"danger"},{default:a(()=>l[29]||(l[29]=[i("WAF防护")])),_:1,__:[29]})):S("",!0)]),_:1})],512),[[ve,d.value===2]]),te(f("div",null,[t(c,{label:"防护带宽(Mbps)",prop:"bandwidth"},{default:a(()=>[t(L,{modelValue:e.bandwidth,"onUpdate:modelValue":l[8]||(l[8]=u=>e.bandwidth=u),min:1,max:1e4},null,8,["modelValue"])]),_:1}),t(c,{label:"业务带宽(Mbps)",prop:"businessBandwidth"},{default:a(()=>[t(L,{modelValue:e.businessBandwidth,"onUpdate:modelValue":l[9]||(l[9]=u=>e.businessBandwidth=u),min:1,max:5e3},null,8,["modelValue"])]),_:1}),t(c,{label:"业务QPS",prop:"qps"},{default:a(()=>[t(L,{modelValue:e.qps,"onUpdate:modelValue":l[10]||(l[10]=u=>e.qps=u),min:1,max:1e5},null,8,["modelValue"])]),_:1}),t(c,{label:"防护IP数",prop:"protectionIpCount"},{default:a(()=>[t(L,{modelValue:e.protectionIpCount,"onUpdate:modelValue":l[11]||(l[11]=u=>e.protectionIpCount=u),min:1,max:100},null,8,["modelValue"])]),_:1}),t(c,{label:"防护域名数",prop:"domainCount"},{default:a(()=>[t(L,{modelValue:e.domainCount,"onUpdate:modelValue":l[12]||(l[12]=u=>e.domainCount=u),min:1,max:1e3},null,8,["modelValue"])]),_:1}),t(c,{label:"端口数量",prop:"portCount"},{default:a(()=>[t(L,{modelValue:e.portCount,"onUpdate:modelValue":l[13]||(l[13]=u=>e.portCount=u),min:1,max:100},null,8,["modelValue"])]),_:1})],512),[[ve,d.value===3]]),te(f("div",null,[t(c,{label:"实例状态",prop:"status"},{default:a(()=>[t(ne,{modelValue:e.status,"onUpdate:modelValue":l[14]||(l[14]=u=>e.status=u)},{default:a(()=>[t(G,{label:"active"},{default:a(()=>l[30]||(l[30]=[i("启用")])),_:1,__:[30]}),t(G,{label:"inactive"},{default:a(()=>l[31]||(l[31]=[i("禁用")])),_:1,__:[31]})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"备注",prop:"remark"},{default:a(()=>[t(n,{modelValue:e.remark,"onUpdate:modelValue":l[15]||(l[15]=u=>e.remark=u),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})],512),[[ve,d.value===4]])]),_:1},8,["model"]),f("div",ze,[f("div",null,[d.value>0?(y(),w(oe,{key:0,onClick:de},{default:a(()=>l[32]||(l[32]=[i("上一步")])),_:1,__:[32]})):S("",!0)]),f("div",null,[t(oe,{onClick:ce},{default:a(()=>l[33]||(l[33]=[i("取消")])),_:1,__:[33]}),d.value<4?(y(),w(oe,{key:0,type:"primary",onClick:pe},{default:a(()=>l[34]||(l[34]=[i("下一步")])),_:1,__:[34]})):(y(),w(oe,{key:1,type:"primary",onClick:p},{default:a(()=>l[35]||(l[35]=[i("提交")])),_:1,__:[35]}))])])]),_:1},8,["modelValue","title"])}}},Fe=we(Re,[["__scopeId","data-v-5ff56af9"]]),Oe={key:0},Me={class:"info-section"},qe={class:"info-item"},Ee={class:"info-item"},We={class:"info-item"},je={class:"info-item"},Le={class:"info-item"},Ye={key:0},Qe={class:"allocation-options"},Ke={key:2,class:"allocation-form"},He={key:3,class:"allocation-form"},Je={key:0,class:"table-footer"},Xe={key:0,class:"error-tip"},Ze={key:4,class:"allocation-form"},et={class:"dialog-footer"},tt={__name:"IpAllocationModal",props:{modelValue:{type:Boolean,default:!1},instanceData:{type:Object,default:null}},emits:["update:modelValue","success"],setup(M,{emit:Y}){const I=M,q=Y,z=Ie({get:()=>I.modelValue,set:p=>q("update:modelValue",p)}),x=b(!1),T=b("auto"),k=b([]),P=b([]),R=b([]),d=b([]),e=b({count:1}),C=b({ipType:"IPv4",regionId:""}),U=b({ip:""}),N=Ie(()=>{if(!I.instanceData)return 0;const p=I.instanceData.protectionIpCount||0,r=d.value.length;return Math.max(0,p-r)}),Q=()=>{I.instanceData&&I.instanceData.protectionIps?d.value=Array.isArray(I.instanceData.protectionIps)?I.instanceData.protectionIps.map(p=>typeof p=="object"&&p!==null?p:{ip:p}):[]:d.value=[],T.value="auto",k.value=[],P.value=[],e.value={count:1},C.value={ipType:"IPv4",regionId:""},U.value={ip:""}};ee(()=>I.instanceData,p=>{p&&ke(()=>{Q()})},{immediate:!0}),ee(()=>z.value,p=>{p&&ke(()=>{Q(),H()})});const K=()=>{z.value=!1,d.value=[]},H=async()=>{try{R.value=[{regionId:"cn-beijing",regionName:"华北-北京"},{regionId:"cn-shanghai",regionName:"华东-上海"},{regionId:"cn-guangzhou",regionName:"华南-广州"},{regionId:"cn-hangzhou",regionName:"华东-杭州"},{regionId:"cn-shenzhen",regionName:"华南-深圳"}]}catch(p){console.error("获取地域列表失败:",p)}},se=async()=>{if(!C.value.ipType){v.warning("请选择IP类型");return}if(!I.instanceData.isAnycast&&!C.value.regionId){v.warning("请选择地域");return}x.value=!0;try{const p=await O.getAvailableProtectionIps();p.code===200?(P.value=p.data.filter(r=>!(r.type!==C.value.ipType||I.instanceData.isAnycast!==r.isAnycast||!I.instanceData.isAnycast&&C.value.regionId&&r.region!==C.value.regionId||d.value.some($=>$.ip===r.ip))),k.value=[]):v.error(p.message||"获取可用IP失败")}catch(p){console.error("获取可用IP列表失败:",p),v.error("获取可用IP列表失败")}finally{x.value=!1}},ae=p=>{k.value=p},re=()=>{if(k.value.length===0){v.warning("请选择要添加的IP");return}if(k.value.length>N.value){v.warning(`最多还可添加${N.value}个IP`);return}const p=k.value.map(r=>({ip:r.ip}));d.value=[...d.value,...p],k.value=[],P.value=[]},ue=async()=>{if(e.value.count<=0){v.warning("请输入有效的分配数量");return}if(e.value.count>N.value){v.warning(`最多还可分配${N.value}个IP`);return}x.value=!0;try{const p=await O.getAvailableProtectionIps();if(p.code===200){const $=p.data.filter(h=>!(I.instanceData.addressType==="IPv4"&&h.type!=="IPv4"||I.instanceData.addressType==="IPv6"&&h.type!=="IPv6"||I.instanceData.isAnycast!==h.isAnycast||!I.instanceData.isAnycast&&I.instanceData.regionId&&h.region!==I.instanceData.regionId||d.value.some(F=>F.ip===h.ip))).sort(()=>.5-Math.random()).slice(0,e.value.count).map(h=>({ip:h.ip}));$.length>0?(d.value=[...d.value,...$],v.success(`已自动分配${$.length}个IP`)):v.warning("没有可用的IP可分配")}else v.error(p.message||"自动分配IP失败")}catch(p){console.error("自动分配IP失败:",p),v.error("自动分配IP失败")}finally{x.value=!1}},ie=()=>{if(!U.value.ip){v.warning("请输入IP地址");return}if(N.value<=0){v.warning("IP配额已用完");return}if(d.value.some(r=>r.ip===U.value.ip)){v.warning("该IP已添加");return}d.value.push({ip:U.value.ip}),U.value.ip=""},de=p=>{d.value.splice(p,1)},pe=async()=>{if(I.instanceData)try{const p=d.value.map($=>$.ip),r=await O.allocateProtectionIps(I.instanceData.instanceId,p);r.code===200?(v.success("分配成功"),z.value=!1,q("success")):v.error(r.message||"分配失败")}catch(p){console.error("分配防护IP失败:",p),v.error("分配防护IP失败")}},ce=p=>({IPv4:"IPv4",IPv6:"IPv6",dual:"双栈"})[p]||p;return(p,r)=>{var W;const $=g("el-divider"),h=g("el-table-column"),F=g("el-button"),le=g("el-table"),me=g("el-empty"),J=g("el-radio"),fe=g("el-radio-group"),X=g("el-input-number"),E=g("el-form-item"),o=g("el-form"),l=g("el-option"),A=g("el-select"),s=g("el-input"),n=g("el-dialog"),c=Te("loading");return y(),w(n,{modelValue:z.value,"onUpdate:modelValue":r[5]||(r[5]=_=>z.value=_),title:`分配防护IP - ${((W=M.instanceData)==null?void 0:W.instanceName)||""}`,width:"60%","destroy-on-close":""},{footer:a(()=>[f("div",et,[t(F,{onClick:K},{default:a(()=>r[21]||(r[21]=[i("取消")])),_:1,__:[21]}),t(F,{type:"primary",onClick:pe},{default:a(()=>r[22]||(r[22]=[i("确认")])),_:1,__:[22]})])]),default:a(()=>[M.instanceData?(y(),B("div",Oe,[f("div",Me,[f("div",qe,[r[6]||(r[6]=f("span",{class:"label"},"业务实例ID:",-1)),f("span",null,V(M.instanceData.instanceId),1)]),f("div",Ee,[r[7]||(r[7]=f("span",{class:"label"},"客户名称:",-1)),f("span",null,V(M.instanceData.customerName),1)]),f("div",We,[r[8]||(r[8]=f("span",{class:"label"},"地址类型:",-1)),f("span",null,V(ce(M.instanceData.addressType)),1)]),f("div",je,[r[9]||(r[9]=f("span",{class:"label"},"IP数量配额:",-1)),f("span",null,V(M.instanceData.protectionIpCount),1)]),f("div",Le,[r[10]||(r[10]=f("span",{class:"label"},"已分配数量:",-1)),f("span",null,V(d.value.length),1)])]),t($,{"content-position":"left"},{default:a(()=>r[11]||(r[11]=[i("当前已分配IP")])),_:1,__:[11]}),d.value.length>0?(y(),B("div",Ye,[t(le,{data:d.value,style:{width:"100%"},border:""},{default:a(()=>[t(h,{label:"IP地址",prop:"ip"}),t(h,{label:"操作",width:"100"},{default:a(_=>[t(F,{type:"danger",size:"small",onClick:G=>de(_.$index)},{default:a(()=>r[12]||(r[12]=[i(" 移除 ")])),_:2,__:[12]},1032,["onClick"])]),_:1})]),_:1},8,["data"])])):(y(),w(me,{key:1,description:"暂无已分配IP"})),t($,{"content-position":"left"},{default:a(()=>r[13]||(r[13]=[i("分配新IP")])),_:1,__:[13]}),f("div",Qe,[t(fe,{modelValue:T.value,"onUpdate:modelValue":r[0]||(r[0]=_=>T.value=_)},{default:a(()=>[t(J,{value:"auto"},{default:a(()=>r[14]||(r[14]=[i("自动分配")])),_:1,__:[14]}),t(J,{value:"pool"},{default:a(()=>r[15]||(r[15]=[i("从IP池选择")])),_:1,__:[15]}),t(J,{value:"manual"},{default:a(()=>r[16]||(r[16]=[i("手动输入")])),_:1,__:[16]})]),_:1},8,["modelValue"])]),T.value==="auto"?(y(),B("div",Ke,[t(o,{model:e.value,"label-width":"120px"},{default:a(()=>[t(E,{label:"分配数量"},{default:a(()=>[t(X,{modelValue:e.value.count,"onUpdate:modelValue":r[1]||(r[1]=_=>e.value.count=_),min:1,max:N.value,disabled:N.value<=0},null,8,["modelValue","max","disabled"])]),_:1}),t(E,null,{default:a(()=>[t(F,{type:"primary",onClick:ue,disabled:N.value<=0},{default:a(()=>r[17]||(r[17]=[i(" 自动分配 ")])),_:1,__:[17]},8,["disabled"])]),_:1})]),_:1},8,["model"])])):S("",!0),T.value==="pool"?(y(),B("div",He,[t(o,{model:C.value,"label-width":"120px"},{default:a(()=>[t(E,{label:"IP类型"},{default:a(()=>[t(A,{modelValue:C.value.ipType,"onUpdate:modelValue":r[2]||(r[2]=_=>C.value.ipType=_),placeholder:"请选择IP类型"},{default:a(()=>[t(l,{label:"IPv4",value:"IPv4"}),t(l,{label:"IPv6",value:"IPv6"})]),_:1},8,["modelValue"])]),_:1}),M.instanceData.isAnycast?S("",!0):(y(),w(E,{key:0,label:"地域"},{default:a(()=>[t(A,{modelValue:C.value.regionId,"onUpdate:modelValue":r[3]||(r[3]=_=>C.value.regionId=_),placeholder:"请选择地域"},{default:a(()=>[(y(!0),B(ge,null,ye(R.value,_=>(y(),w(l,{key:_.regionId,label:_.regionName,value:_.regionId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})),t(E,null,{default:a(()=>[t(F,{type:"primary",onClick:se},{default:a(()=>r[18]||(r[18]=[i(" 查询可用IP ")])),_:1,__:[18]})]),_:1})]),_:1},8,["model"]),t($,{"content-position":"left"},{default:a(()=>r[19]||(r[19]=[i("可用IP列表")])),_:1,__:[19]}),te((y(),w(le,{data:P.value,style:{width:"100%"},border:"",onSelectionChange:ae},{default:a(()=>[t(h,{type:"selection",width:"55"}),t(h,{label:"IP地址",prop:"ip"}),t(h,{label:"类型",prop:"type",width:"100"}),t(h,{label:"Anycast",width:"100"},{default:a(_=>[i(V(_.row.isAnycast?"是":"否"),1)]),_:1}),t(h,{label:"地域",prop:"region",width:"150"})]),_:1},8,["data"])),[[c,x.value]]),P.value.length>0?(y(),B("div",Je,[t(F,{type:"primary",onClick:re,disabled:k.value.length===0||k.value.length>N.value},{default:a(()=>[i(" 添加选中IP ("+V(k.value.length)+") ",1)]),_:1},8,["disabled"]),k.value.length>N.value?(y(),B("div",Xe," 选择的IP数量超过剩余配额 ")):S("",!0)])):S("",!0)])):S("",!0),T.value==="manual"?(y(),B("div",Ze,[t(o,{model:U.value,"label-width":"120px"},{default:a(()=>[t(E,{label:"IP地址"},{default:a(()=>[t(s,{modelValue:U.value.ip,"onUpdate:modelValue":r[4]||(r[4]=_=>U.value.ip=_),placeholder:"请输入IP地址",style:{width:"300px"}},null,8,["modelValue"])]),_:1}),t(E,null,{default:a(()=>[t(F,{type:"primary",onClick:ie,disabled:!U.value.ip||N.value<=0},{default:a(()=>r[20]||(r[20]=[i(" 添加 ")])),_:1,__:[20]},8,["disabled"])]),_:1})]),_:1},8,["model"])])):S("",!0)])):S("",!0)]),_:1},8,["modelValue","title"])}}},at=we(tt,[["__scopeId","data-v-926c8185"]]),lt={class:"business-instance-container"},nt={class:"card-header"},ot={class:"search-area"},st={class:"pagination-container"},rt={class:"text-xs text-gray-500 mt-2"},ut={class:"text-xs text-gray-500 mt-2"},it={__name:"BusinessInstance",setup(M){const Y=b(!1),I=b([]),q=b(!1),z=b(!1),x=b(!1),T=b(!1),k=b(!1),P=b(null),R=b([]),d=_e({keyword:"",dateRange:[]}),e=_e({pageNum:1,pageSize:10,total:0});xe(()=>{C(),U()});const C=async()=>{try{Y.value=!0;const s={keyword:d.keyword,status:d.status,pageNum:e.pageNum,pageSize:e.pageSize};d.dateRange&&d.dateRange.length===2&&(s.dateRange=d.dateRange);const n=await O.getBusinessInstances(s);n.code===200?(I.value=n.data.list.map(c=>(!c.clusterType&&c.isAnycast!==void 0&&(c.clusterType=c.isAnycast?"anycast":"standby"),c)),e.total=n.data.total,e.pageNum=n.data.pageNum,e.pageSize=n.data.pageSize):v.error(n.message||"获取业务实例列表失败")}catch(s){console.error("获取业务实例列表失败:",s),v.error("获取业务实例列表失败")}finally{Y.value=!1}},U=async()=>{try{R.value=await Pe.getClusterGroups()}catch(s){console.error("获取逻辑集群组列表失败:",s)}},N=s=>{if(s.clusterGroupName)return s.clusterGroupName;const n=R.value.find(c=>c.id===s.clusterGroupId);return n?n.name:s.clusterGroupId},Q=s=>{const n=R.value.find(W=>W.id===s.clusterGroupId);if(!n)return`集群组ID: ${s.clusterGroupId}`;let c="主备";return n.type==="anycast"?c="Anycast":(n.type==="distributed"||n.distributed)&&(c="分布式"),`${n.name} (${c}类型)
${n.remark||""}`},K=s=>{s.clusterGroupId&&v({message:`查看集群组: ${N(s)}`,type:"info"})},H=()=>{e.pageNum=1,C()},se=()=>{d.keyword="",d.dateRange=[],e.pageNum=1,C()},ae=s=>{e.pageSize=s,C()},re=s=>{e.pageNum=s,C()},ue=()=>{P.value=null,k.value=!1,q.value=!0},ie=s=>{P.value={...s},k.value=!0,q.value=!0},de=s=>{P.value={...s},x.value=!0},pe=async()=>{try{const s=await O.enableBusinessInstance(P.value.instanceId);s.code===200?(v.success("启用成功"),x.value=!1,C()):v.error(s.message||"启用失败")}catch(s){console.error("启用业务实例失败:",s),v.error("启用业务实例失败")}},ce=s=>{P.value={...s},T.value=!0},p=async()=>{try{const s=await O.disableBusinessInstance(P.value.instanceId);s.code===200?(v.success("禁用成功"),T.value=!1,C()):v.error(s.message||"禁用失败")}catch(s){console.error("禁用业务实例失败:",s),v.error("禁用业务实例失败")}},r=s=>{P.value=s,z.value=!0},$=s=>{Se.confirm("确定要删除该业务实例吗？删除后无法恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const n=await O.deleteBusinessInstance(s.instanceId);n.code===200?(v.success("删除成功"),C()):v.error(n.message||"删除失败")}catch(n){console.error("删除业务实例失败:",n),v.error("删除业务实例失败")}}).catch(()=>{})},h=()=>{C()},F=()=>{C(),P.value=null,z.value=!1},le=(s,n)=>n.status===s,me=(s,n)=>n.clusterType===s,J=(s,n)=>n.addressType===s,fe=s=>({active:"success",inactive:"info"})[s]||"info",X=s=>({active:"已启用",inactive:"已禁用"})[s]||s,E=s=>({standby:"primary",distributed:"success",anycast:"warning"})[s]||"info",o=s=>({standby:"主备",distributed:"分布式",anycast:"Anycast"})[s]||s,l=s=>({IPv4:"primary",IPv6:"success",dual:"warning"})[s]||"info",A=s=>({IPv4:"IPv4",IPv6:"IPv6",dual:"双栈"})[s]||s;return(s,n)=>{const c=g("el-button"),W=g("el-icon"),_=g("el-input"),G=g("el-form-item"),ne=g("el-date-picker"),Z=g("el-form"),D=g("el-table-column"),L=g("el-tag"),be=g("el-link"),oe=g("el-tooltip"),Ce=g("el-table"),u=g("el-pagination"),he=g("el-card"),Ve=g("el-dialog"),De=Te("loading");return y(),B("div",lt,[t(he,{class:"box-card"},{header:a(()=>[f("div",nt,[n[11]||(n[11]=f("span",null,"业务实例管理",-1)),t(c,{type:"primary",onClick:ue},{default:a(()=>n[10]||(n[10]=[i("新增业务实例")])),_:1,__:[10]})])]),default:a(()=>[f("div",ot,[t(Z,{inline:!0,model:d,class:"search-form"},{default:a(()=>[t(G,null,{default:a(()=>[t(_,{modelValue:d.keyword,"onUpdate:modelValue":n[0]||(n[0]=m=>d.keyword=m),placeholder:"搜索业务实例名称/ID/客户名称/订单ID",clearable:"",onKeyup:Ne(H,["enter"])},{prefix:a(()=>[t(W,null,{default:a(()=>[t(Ae(Ge))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(G,null,{default:a(()=>[t(ne,{modelValue:d.dateRange,"onUpdate:modelValue":n[1]||(n[1]=m=>d.dateRange=m),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(G,null,{default:a(()=>[t(c,{type:"primary",onClick:H},{default:a(()=>n[12]||(n[12]=[i("搜索")])),_:1,__:[12]}),t(c,{onClick:se},{default:a(()=>n[13]||(n[13]=[i("重置")])),_:1,__:[13]})]),_:1})]),_:1},8,["model"])]),te((y(),w(Ce,{data:I.value,border:"",stripe:"",style:{width:"100%","min-height":"320px"},"row-key":"instanceId","max-height":"500","row-class-name":"dense-row","header-cell-style":{position:"sticky",top:0,background:"#fff",zIndex:2}},{empty:a(()=>n[19]||(n[19]=[f("div",{class:"text-gray-400 py-10 text-center"},"暂无数据",-1)])),default:a(()=>[t(D,{prop:"instanceId",label:"业务实例ID",width:"150",fixed:"left"}),t(D,{prop:"instanceName",label:"业务实例名称","min-width":"150"}),t(D,{prop:"customerName",label:"客户名称","min-width":"180"}),t(D,{prop:"orderId",label:"订单ID",width:"150"}),t(D,{prop:"packageName",label:"套餐名称",width:"120"}),t(D,{label:"集群类型",width:"120",filters:[{text:"主备",value:"standby"},{text:"分布式",value:"distributed"},{text:"Anycast",value:"anycast"}],"filter-method":me,"filter-placement":"bottom-end"},{default:a(({row:m})=>[t(L,{type:E(m.clusterType)},{default:a(()=>[i(V(o(m.clusterType)),1)]),_:2},1032,["type"])]),_:1}),t(D,{prop:"addressType",label:"地址类型",width:"100",filters:[{text:"IPv4",value:"IPv4"},{text:"IPv6",value:"IPv6"},{text:"双栈",value:"dual"}],"filter-method":J,"filter-placement":"bottom-end"},{default:a(({row:m})=>[t(L,{type:l(m.addressType)},{default:a(()=>[i(V(A(m.addressType)),1)]),_:2},1032,["type"])]),_:1}),t(D,{label:"逻辑集群组","min-width":"180"},{default:a(({row:m})=>[t(oe,{effect:"light",content:Q(m),placement:"top","show-after":500},{default:a(()=>[t(be,{type:"primary",onClick:j=>K(m)},{default:a(()=>[i(V(N(m)),1)]),_:2},1032,["onClick"])]),_:2},1032,["content"])]),_:1}),t(D,{prop:"bandwidth",label:"防护带宽(Mbps)",width:"140",sortable:""}),t(D,{prop:"businessBandwidth",label:"业务带宽(Mbps)",width:"140",sortable:""}),t(D,{prop:"qps",label:"业务QPS",width:"120",sortable:""}),t(D,{prop:"protectionIpCount",label:"防护IP数",width:"120",sortable:""}),t(D,{prop:"domainCount",label:"防护域名数",width:"120",sortable:""}),t(D,{prop:"portCount",label:"端口数量",width:"120",sortable:""}),t(D,{prop:"status",label:"状态",width:"100",filters:[{text:"已启用",value:"active"},{text:"已禁用",value:"inactive"}],"filter-method":le,"filter-placement":"bottom-end"},{default:a(({row:m})=>[t(L,{type:fe(m.status)},{default:a(()=>[i(V(X(m.status)),1)]),_:2},1032,["type"])]),_:1}),t(D,{prop:"createTime",label:"创建时间",width:"180",sortable:""}),t(D,{label:"操作",width:"320",fixed:"right"},{default:a(({row:m})=>[m.status==="inactive"?(y(),w(c,{key:0,type:"success",link:"",onClick:j=>de(m)},{default:a(()=>n[14]||(n[14]=[i(" 启用 ")])),_:2,__:[14]},1032,["onClick"])):S("",!0),m.status==="active"?(y(),w(c,{key:1,type:"warning",link:"",onClick:j=>ce(m)},{default:a(()=>n[15]||(n[15]=[i(" 禁用 ")])),_:2,__:[15]},1032,["onClick"])):S("",!0),t(c,{type:"primary",link:"",onClick:j=>ie(m)},{default:a(()=>n[16]||(n[16]=[i(" 修改配置 ")])),_:2,__:[16]},1032,["onClick"]),t(c,{type:"primary",link:"",onClick:j=>r(m)},{default:a(()=>n[17]||(n[17]=[i(" 分配防护IP ")])),_:2,__:[17]},1032,["onClick"]),t(c,{type:"danger",link:"",onClick:j=>$(m)},{default:a(()=>n[18]||(n[18]=[i(" 删除 ")])),_:2,__:[18]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[De,Y.value]]),f("div",st,[t(u,{"current-page":e.pageNum,"onUpdate:currentPage":n[2]||(n[2]=m=>e.pageNum=m),"page-size":e.pageSize,"onUpdate:pageSize":n[3]||(n[3]=m=>e.pageSize=m),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:e.total,background:"",onSizeChange:ae,onCurrentChange:re},null,8,["current-page","page-size","total"])])]),_:1}),t(Fe,{modelValue:q.value,"onUpdate:modelValue":n[4]||(n[4]=m=>q.value=m),"instance-data":P.value,"is-edit":k.value,onSuccess:h},null,8,["modelValue","instance-data","is-edit"]),t(at,{modelValue:z.value,"onUpdate:modelValue":n[5]||(n[5]=m=>z.value=m),"instance-data":P.value,onSuccess:F},null,8,["modelValue","instance-data"]),t(Ve,{modelValue:x.value,"onUpdate:modelValue":n[7]||(n[7]=m=>x.value=m),title:"确认启用",width:"400px"},{footer:a(()=>[t(c,{onClick:n[6]||(n[6]=m=>x.value=!1)},{default:a(()=>n[22]||(n[22]=[i("取消")])),_:1,__:[22]}),t(c,{type:"success",onClick:pe},{default:a(()=>n[23]||(n[23]=[i("确认启用")])),_:1,__:[23]})]),default:a(()=>{var m,j;return[f("div",null,[n[20]||(n[20]=i("确定要启用业务实例 ")),f("b",null,V((m=P.value)==null?void 0:m.instanceName),1),n[21]||(n[21]=i(" 吗？"))]),f("div",rt,"ID: "+V((j=P.value)==null?void 0:j.instanceId),1)]}),_:1},8,["modelValue"]),t(Ve,{modelValue:T.value,"onUpdate:modelValue":n[9]||(n[9]=m=>T.value=m),title:"确认禁用",width:"400px"},{footer:a(()=>[t(c,{onClick:n[8]||(n[8]=m=>T.value=!1)},{default:a(()=>n[26]||(n[26]=[i("取消")])),_:1,__:[26]}),t(c,{type:"warning",onClick:p},{default:a(()=>n[27]||(n[27]=[i("确认禁用")])),_:1,__:[27]})]),default:a(()=>{var m,j;return[f("div",null,[n[24]||(n[24]=i("确定要禁用业务实例 ")),f("b",null,V((m=P.value)==null?void 0:m.instanceName),1),n[25]||(n[25]=i(" 吗？"))]),f("div",ut,"ID: "+V((j=P.value)==null?void 0:j.instanceId),1)]}),_:1},8,["modelValue"])])}}},pt=we(it,[["__scopeId","data-v-564e6ba4"]]);export{pt as default};
